{"version":3,"file":"dfp.service.js","sourceRoot":"","sources":["../../src/service/dfp.service.ts"],"names":[],"mappings":"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","sourcesContent":["import { Injectable, Optional, PLATFORM_ID, Inject } from '@angular/core';\nimport { isPlatformBrowser } from '@angular/common';\n\nimport { DfpConfig, DFP_CONFIG } from '../class';\nimport { IdleService } from './idle.service';\nimport { ScriptInjectorService } from './script-injector.service';\n\nexport const GPT_LIBRARY_URL = '//www.googletagservices.com/tag/js/gpt.js';\n\nclass DFPConfigurationError extends Error { }\n\n@Injectable()\nexport class DfpService {\n\n  private enableVideoAds = false;\n\n  private personalizedAds = true;\n\n  private collapseIfEmpty = true;\n\n  private centering = false;\n\n  private location = null;\n\n  private ppid = null;\n\n  private globalTargeting = null;\n\n  private forceSafeFrame = false;\n\n  private safeFrameConfig = null;\n\n  private loadGPT = true;\n\n  private loaded = false;\n\n  constructor(\n    @Inject(PLATFORM_ID) private platformId: Object,\n    @Optional() idleLoad: IdleService,\n    @Inject(DFP_CONFIG) private config: DfpConfig,\n    private scriptInjector: ScriptInjectorService\n  ) {\n    if (isPlatformBrowser(this.platformId)) {\n      const win: any = window,\n        googletag = win.googletag || {};\n\n      this.dfpConfig();\n\n      googletag.cmd = googletag.cmd || [];\n      googletag.cmd.push(() => {\n        this.setup();\n      });\n      win.googletag = googletag;\n\n      if (this.loadGPT) {\n        const loadScript = () => {\n          this.scriptInjector.scriptInjector(GPT_LIBRARY_URL).then((script) => {\n            this.loaded = true;\n          });\n        };\n        if (idleLoad) {\n          idleLoad.request(loadScript);\n        } else {\n          loadScript();\n        }\n      }\n    }\n  }\n\n  private dfpConfig() {\n    for (const key in this.config) {\n      if (this.hasOwnProperty(key)) {\n        this[key] = this.config[key];\n      }\n    }\n  }\n\n  private addSafeFrameConfig(pubads) {\n    if (!this.safeFrameConfig) { return false; }\n    if (typeof this.safeFrameConfig !== 'object') {\n      throw new DFPConfigurationError('FrameConfig must be an object');\n    }\n    pubads.setSafeFrameConfig(this.safeFrameConfig);\n  }\n\n  private addTargeting(pubads) {\n    if (!this.globalTargeting) { return false; }\n    if (typeof this.globalTargeting !== 'object') {\n      throw new DFPConfigurationError('Targeting must be an object');\n    }\n\n    for (const key in this.globalTargeting) {\n      if (this.globalTargeting.hasOwnProperty(key)) {\n        pubads.setTargeting(key, this.globalTargeting[key]);\n      }\n    }\n  }\n\n  private addLocation(pubads) {\n    if (!this.location) { return false; }\n\n    if (typeof this.location === 'string') {\n      pubads.setLocation(this.location);\n      return;\n    }\n\n    if (!Array.isArray(this.location)) {\n      throw new DFPConfigurationError('Location must be an ' +\n        'array or string');\n    }\n\n    pubads.setLocation.apply(pubads, this.location);\n  }\n\n  private addPPID(pubads) {\n    if (!this.ppid) { return false; }\n    if (typeof this.ppid !== 'string') {\n      throw new DFPConfigurationError('PPID must be a string');\n    }\n\n    pubads.setPublisherProvidedId(this.ppid);\n  }\n\n  private setup() {\n    const win: any = window,\n      googletag = win.googletag,\n      pubads = googletag.pubads();\n\n    if (this.enableVideoAds) {\n      pubads.enableVideoAds();\n    }\n\n    // personalizedAds is default\n    if (this.personalizedAds === false) {\n      pubads.setRequestNonPersonalizedAds(1);\n    }\n\n    if (this.collapseIfEmpty) {\n      pubads.collapseEmptyDivs();\n    }\n\n    // We always refresh ourselves\n    pubads.disableInitialLoad();\n\n    pubads.setForceSafeFrame(this.forceSafeFrame);\n    pubads.setCentering(this.centering);\n\n    this.addLocation(pubads);\n    this.addPPID(pubads);\n    this.addTargeting(pubads);\n    this.addSafeFrameConfig(pubads);\n\n    // pubads.enableSyncRendering();\n    pubads.enableAsyncRendering();\n\n    if (this.config.singleRequestMode !== true) {\n      if (this.config.enableVideoAds) {\n        pubads.enableVideoAds();\n      }\n      googletag.enableServices();\n    }\n\n  }\n\n  hasLoaded() {\n    return this.loaded;\n  }\n\n  defineTask(task) {\n    if (isPlatformBrowser(this.platformId)) {\n      const win: any = window,\n        googletag = win.googletag;\n      googletag.cmd.push(task);\n    }\n  }\n\n}\n"]}