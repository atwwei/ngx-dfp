{"version":3,"file":"dfp-ad.directive.js","sourceRoot":"","sources":["../../src/directive/dfp-ad.directive.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  Directive, ElementRef,\n  Input, Output, EventEmitter,\n  OnInit, AfterViewInit, OnDestroy, Inject, PLATFORM_ID, Optional\n} from '@angular/core';\nimport { isPlatformBrowser } from '@angular/common';\nimport { Router, NavigationEnd } from '@angular/router';\n\nimport { Subscription } from 'rxjs';\nimport { filter } from 'rxjs/operators';\n\nimport { DfpService, DfpIDGeneratorService, DfpRefreshService } from '../service';\n\nimport { DFPIncompleteError, GoogleSlot, DfpConfig, DFP_CONFIG } from '../class';\n\ndeclare var googletag;\n\nexport class DfpRefreshEvent {\n  type: string;\n  slot: any;\n  data?: any;\n}\n\n@Directive({\n  selector: 'dfp-ad'\n})\nexport class DfpAdDirective implements OnInit, AfterViewInit, OnDestroy {\n\n  @Input() adUnit: string;\n  @Input() clickUrl: string;\n  @Input() forceSafeFrame: boolean;\n  @Input() safeFrameConfig: string;\n  @Input() refresh: string;\n  @Input() personalizedAds: boolean = this.config.personalizedAds;\n  @Input() collapseIfEmpty: boolean;\n\n  @Output() afterRefresh: EventEmitter<DfpRefreshEvent> = new EventEmitter();\n\n  private sizes = [];\n\n  private responsiveMapping = [];\n\n  private targetings = [];\n\n  private exclusions = [];\n\n  private scripts = [];\n\n  private slot: GoogleSlot;\n\n  private onSameNavigation: Subscription;\n\n  constructor(\n    @Inject(PLATFORM_ID) private platformId: Object,\n    private elementRef: ElementRef,\n    private dfp: DfpService,\n    private dfpIDGenerator: DfpIDGeneratorService,\n    private dfpRefresh: DfpRefreshService,\n    @Inject(DFP_CONFIG) private config: DfpConfig,\n    @Optional() router: Router\n  ) {\n    if (isPlatformBrowser(this.platformId)) {\n      this.dfpRefresh.refreshEvent.subscribe(slot => {\n        if (slot === this.slot) {\n          this.afterRefresh.emit({ type: 'refresh', slot: slot });\n        }\n      });\n      if (router) {\n        this.onSameNavigation = router.events.pipe(filter(event => event instanceof NavigationEnd))\n          .subscribe((event: NavigationEnd) => {\n            if (this.slot && !this.refresh && this.config.onSameNavigation === 'refresh') {\n              this.refreshContent.call(this);\n            }\n          });\n      }\n    }\n  }\n\n  ngOnInit() {\n    if (isPlatformBrowser(this.platformId)) {\n      this.dfpIDGenerator.dfpIDGenerator(this.elementRef.nativeElement);\n    }\n  }\n\n  ngAfterViewInit() {\n    if (isPlatformBrowser(this.platformId)) {\n      this.dfp.defineTask(() => {\n        this.defineSlot();\n      });\n    }\n  }\n\n  ngOnDestroy() {\n    if (this.slot) {\n      googletag.destroySlots([this.slot]);\n    }\n    if (this.onSameNavigation) {\n      this.onSameNavigation.unsubscribe();\n    }\n  }\n\n  private setResponsiveMapping(slot) {\n    const ad = this.getState();\n\n    if (ad.responsiveMapping.length === 0) {\n      return;\n    }\n\n    const sizeMapping = googletag.sizeMapping();\n\n    ad.responsiveMapping.forEach(mapping => {\n      sizeMapping.addSize(mapping.viewportSize, mapping.adSizes);\n    });\n\n    slot.defineSizeMapping(sizeMapping.build());\n  }\n\n  private defineSlot() {\n    const ad = this.getState(),\n      element = this.elementRef.nativeElement;\n\n    this.slot = googletag.defineSlot(ad.adUnit, ad.sizes, element.id);\n\n    if (ad.forceSafeFrame !== undefined) {\n      this.slot.setForceSafeFrame(true);\n    }\n\n    if (this.personalizedAds === true) {\n      this.slot.set('requestNonPersonalizedAds', 0);\n      googletag.pubads().setRequestNonPersonalizedAds(0);\n    }\n\n    if (ad.clickUrl) {\n      this.slot.setClickUrl(ad.clickUrl);\n    }\n\n    if (ad.collapseIfEmpty) {\n      this.slot.setCollapseEmptyDiv(true, true);\n    }\n\n    if (ad.safeFrameConfig) {\n      this.slot.setSafeFrameConfig(\n        (JSON.parse(ad.safeFrameConfig))\n      );\n    }\n\n    this.slot.renderEnded = (googleSlotEvent: IArguments) => {\n      this.afterRefresh.emit({ type: 'renderEnded', slot: this.slot, data: googleSlotEvent });\n    };\n\n    this.setResponsiveMapping(this.slot);\n\n    ad.targetings.forEach(targeting => {\n      this.slot.setTargeting(targeting.key, targeting.values);\n    });\n\n    ad.exclusions.forEach(exclusion => {\n      this.slot.setCategoryExclusion(exclusion);\n    });\n\n    ad.scripts.forEach(script => { script(this.slot); });\n\n    if (this.config.enableVideoAds) {\n      this.slot.addService(googletag.companionAds());\n    }\n\n    this.slot.addService(googletag.pubads());\n\n    this.refreshContent();\n  }\n\n  private refreshContent() {\n    this.dfpRefresh.slotRefresh(this.slot, this.refresh, true).then(slot => {\n      this.afterRefresh.emit({ type: 'init', slot: slot });\n    });\n  }\n\n  checkValid() {\n    if (this.sizes.length === 0) {\n      throw new DFPIncompleteError('dfp-ad', 'dfp-size');\n    }\n    if (!this.adUnit) {\n      throw new DFPIncompleteError('dfp-ad', 'ad-unit', true);\n    }\n  }\n\n  get isHidden() {\n    return this.dfpRefresh.hiddenCheck(this.elementRef.nativeElement);\n  }\n\n  getState() {\n    this.checkValid();\n    return Object.freeze({\n      sizes: this.sizes,\n      responsiveMapping: this.responsiveMapping,\n      targetings: this.targetings,\n      exclusions: this.exclusions,\n      adUnit: this.adUnit,\n      forceSafeFrame: this.forceSafeFrame === true,\n      safeFrameConfig: this.safeFrameConfig,\n      clickUrl: this.clickUrl,\n      refresh: this.refresh,\n      personalizedAds: this.personalizedAds === this.config.personalizedAds,\n      scripts: this.scripts,\n      collapseIfEmpty: this.collapseIfEmpty === true\n    });\n  }\n\n  addSize(size) {\n    this.sizes.push(size);\n  }\n\n  addResponsiveMapping(mapping) {\n    this.responsiveMapping.push(mapping);\n  }\n\n  addTargeting(targeting) {\n    this.targetings.push(targeting);\n  }\n\n  addExclusion(exclusion) {\n    this.exclusions.push(exclusion);\n  }\n\n  addScript(script) {\n    this.scripts.push(script);\n  }\n\n}\n"]}